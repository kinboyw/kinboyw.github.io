<!DOCTYPE html><html class="theme-next gemini use-motion" lang="ZH | EN"><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="AKuwh4i11uWg0wOl_cM7AI_dHqOHOLKYfCxKc8Lfv6E"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="FE,JavaScript,"><link rel="alternate" href="/atom.xml" title="Kinboy's note" type="application/atom+xml"><meta name="description" content="​    作用域（Scope ）是 JavaScript 语言的基础概念之一，可能是让我在编写复杂程序的时候煎熬最多的。记不清多少次迷失在追踪函数到函数之间传递控制时 this 关键字指向的问题中了，我发现自己经常以各种令人困惑的方式扭曲我的代码，试图对理解变量在哪些地方可以访问的问题上保留一点理智。 ​    这篇文章将会正面解决问题，概述作用域和上下文的定义，测试两种允许我们操作上下文的 Ja"><meta name="keywords" content="FE,JavaScript"><meta property="og:type" content="article"><meta property="og:title" content="JavaScript作用域"><meta property="og:url" content="http://kinboyw.github.io/2019/02/13/JavaScript作用域/index.html"><meta property="og:site_name" content="Kinboy&#39;s note"><meta property="og:description" content="​    作用域（Scope ）是 JavaScript 语言的基础概念之一，可能是让我在编写复杂程序的时候煎熬最多的。记不清多少次迷失在追踪函数到函数之间传递控制时 this 关键字指向的问题中了，我发现自己经常以各种令人困惑的方式扭曲我的代码，试图对理解变量在哪些地方可以访问的问题上保留一点理智。 ​    这篇文章将会正面解决问题，概述作用域和上下文的定义，测试两种允许我们操作上下文的 Ja"><meta property="og:locale" content="ZH | EN"><meta property="og:updated_time" content="2019-07-15T10:05:10.344Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JavaScript作用域"><meta name="twitter:description" content="​    作用域（Scope ）是 JavaScript 语言的基础概念之一，可能是让我在编写复杂程序的时候煎熬最多的。记不清多少次迷失在追踪函数到函数之间传递控制时 this 关键字指向的问题中了，我发现自己经常以各种令人困惑的方式扭曲我的代码，试图对理解变量在哪些地方可以访问的问题上保留一点理智。 ​    这篇文章将会正面解决问题，概述作用域和上下文的定义，测试两种允许我们操作上下文的 Ja"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"I didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://kinboyw.github.io/2019/02/13/JavaScript作用域/"><title>JavaScript作用域 | Kinboy's note</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9c2b9e915e6bb8ec323a2f98c0c98d8";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><body itemscope itemtype="http://schema.org/WebPage" lang="ZH | EN"><div class="container sidebar-position-left page-post-detail"><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"></span><span class="site-title">Kinboy's note</span><span class="logo-line-after"></span></a></div><h1 class="site-subtitle" itemprop="description">前端漫记</h1></div><div class="site-nav-toggle"><button></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><br>Home</a><li class="menu-item menu-item-about"><a href="/rscard/" rel="section"><br>About</a><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><br>Tags</a><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><br>Categories</a><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><br>Archives</a><li class="menu-item menu-item-top"><a href="/top/" rel="section"><br>Top</a><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><br>Search</a></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"></span><span class="popup-btn-close"></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-categories" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://kinboyw.github.io/2019/02/13/JavaScript作用域/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="kinboy"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Kinboy's note"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">JavaScript作用域</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"></span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T16:43:28+08:00">2019-02-13</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/FE/" itemprop="url" rel="index"><span itemprop="name">FE</span></a></span> , <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/FE/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"></span><a href="/2019/02/13/JavaScript作用域/#comments" itemprop="discussionUrl"></a></span><div class="post-wordcount"><span class="post-meta-item-icon"></span><span class="post-meta-item-text">Words count in article&#58;</span> <span title="Words count in article">2.5k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span title="Reading time">13</span></div></div></header><div class="post-body" itemprop="articleBody"><p>​ 作用域（<a href="http://en.wikipedia.org/wiki/Scope_%28programming%29" target="_blank" rel="noopener">Scope</a> ）是 JavaScript 语言的基础概念之一，可能是让我在编写复杂程序的时候煎熬最多的。记不清多少次迷失在追踪函数到函数之间传递控制时 <code>this</code> 关键字指向的问题中了，我发现自己经常以各种令人困惑的方式扭曲我的代码，试图对理解变量在哪些地方可以访问的问题上保留一点理智。<p>​ 这篇文章将会正面解决问题，概述作用域和上下文的定义，测试两种允许我们操作上下文的 JavaScript 方法，并深入探讨我遇到过的 90% 的问题的解决方案。</p><h3 id="this？是什么？"><code>this</code>？是什么？</h3><ul><li><p>调用一个对象的函数<p>​ 在经典的面向对象编程中，我们需要一种方法来标识和指向我们正在操作的对象。<code>this</code> 优秀地满足了这个目的，为我们的对象提供了访问自己和指向自有属性的目的。<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> deep_thought = &#123;</span></span><br><span class="line">  	the_answer: 42,</span><br><span class="line"><span class="javascript">  	ask_question: <span class="function"><span class="keyword">function</span> () </span>&#123;</span></span><br><span class="line"><span class="javascript">  		<span class="keyword">return</span> <span class="keyword">this</span>.the_answer;</span></span><br><span class="line">  	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> the_meaning = deep_thought.ask_question();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>​ 上面的示例构造了 一个对象，名为 <code>deep_thought</code> ，并将它的 <code>this_answer</code> 属性设置为 42，然后创建了一个 <code>ask_question</code> 方法。当 <code>deep_thought.ask_question()</code> 函数被执行的时候，JavaScript 为函数调用创建了一个执行上下文，将 <code>this</code> 设置为调用语句最后一个 ”.” 前面的变量所引用的对象，在这个例子中就是 <code>deep_thought</code> 。这个方法可以在后面通过 <code>this</code> 访问到 <code>deep_thought</code> 的镜像，并查看它的自有属性，并返回 <code>this.the_answer</code> 中保存的值：42。<li><p>构造函数<p>​ 同样的，在定义一个用来作为可以使用 <code>new</code> 关键字的构造函数的方法时，<code>this</code> 可以被用来指向被创建的对象。 我们重写一下上面的例子来体现这个场景：<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">BigComputer</span>(<span class="params">answer</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">this</span>.the_answer = answer;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">this</span>.ask_question = <span class="function"><span class="keyword">function</span> () </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="keyword">this</span>.the_answer;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> deep_thought = <span class="keyword">new</span> BigComputer(<span class="number">42</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> the_meaning = deep_thought.ask_question();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>​ 我并没有显示地创建 <code>deep_thought</code> 对象，而是写了一个方法来创建 <code>BigComputer</code> 对象，然后通过 <code>new</code> 关键字将 <code>deep_thought</code> 实例化为一个实例变量。当 <code>new BigComputer()</code> 被执行的时候，一个全新的对象在后台透明地创建了。<code>BigComputer()</code> 方法被调用，然后它的 <code>this</code> 关键字被设置为指向 这个新创建的对象。这个函数可以将属性和方法设置到 <code>this</code> 上，然后在 <code>BigComputer</code> 执行结束后透明地将其返回。<p>​ 注意，尽管如此，<code>deep_thought.ask_question()</code> 仍然像以前一样工作。发生了什么，为什么 <code>this</code> 在 <code>the_question</code> 中的含义与在 <code>BigComputer</code> 中的不同？简单来说，我们是通过 <code>new</code> 进入 <code>BigComputer</code> 的，所以 <code>this</code> 表示 <code>新创建的对象</code> ，另一方面，我们通过 <code>deep_thought</code> 进入 <code>ask_question</code> ，所以当我们执行这个方法的时候， <code>this</code> 就代表着 <code>deep_thought</code> 指向的任意对象。<code>this</code> 并不是像其他变量一样从作用域链中读取的，而是基于上下文与上下文间重置的。<li><p>方法调用<p>​ 如果我们只是调用一个简单的，没有这些眼花缭乱的对象的方法呢？ <code>this</code> 在这样的情景下指向哪里呢？<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">test_this</span>() </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">return</span> <span class="keyword">this</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> i_wonder_what_this_is = test_this();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>​ 在这种情况下，我们没有通过 <code>new</code> 来提供一个上下文，也没有提供一个对象形式的上下文。在这里 <code>this</code> 会尽可能指向最全局的对象：对 网页来说，就是 <code>window</code> 对象。<li><p>事件处理函数 Event Handler<p>For a more complicated twist on the normal function call, let’s say that we’re using a function to handle an <code>onclick</code> event. What does <code>this</code> mean when the event triggers our function’s execution? Unfortunately, there’s not a simple answer to this question.If we write the event handler inline, <code>this</code> refers to the global <code>window</code> object:<p>对于一个<p>However, when we add an event handler via JavaScript, <code>this</code> refers to the DOM element that generated the event. (Note: The event handling shown here is short and readable, but otherwise poor. Please use a <a href="http://dean.edwards.name/weblog/2005/10/add-event2/" target="_blank" rel="noopener">real addEvent function</a> instead.):</ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre><td class="code"><pre><span class="line">function addhandler() &#123;</span><br><span class="line">document.getElementById(‘thebutton’).onclick = click_handler;</span><br><span class="line">&#125;</span><br><br><span class="line">window.onload = addhandler;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">'thebutton'</span>&gt;</span>Click me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></table></figure><h3 id="Complications">Complications</h3><p>Let’s run with that last example for a moment longer. What if instead of running <code>click_handler</code>, we wanted to ask <code>deep_thought</code> a question every time we clicked the button? The code for that seems pretty straightforward; we might try this:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">BigComputer</span>(<span class="params">answer</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">this</span>.the_answer = answer;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">this</span>.ask_question = <span class="function"><span class="keyword">function</span> () </span>&#123;</span></span><br><span class="line"><span class="javascript">		alert(<span class="keyword">this</span>.the_answer);</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">addhandler</span>() </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> deep_thought = <span class="keyword">new</span> BigComputer(<span class="number">42</span>),</span></span><br><span class="line"><span class="javascript">	the_button = <span class="built_in">document</span>.getElementById(‘thebutton’);</span></span><br><br><span class="line">	the_button.onclick = deep_thought.ask_question;</span><br><span class="line">&#125;</span><br><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = addhandler;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>Perfect, right? We click on the button, <code>deep_thought.ask_question</code> is executed, and we get back “42.” So why is the browser giving us <code>undefined</code> instead? What did we do wrong?<p>The problem is simply this: We’ve passed off a reference to the <code>ask_question</code> method, which, when executed as an event handler, runs in a different context than when it’s executed as an object method. In short, the <code>this</code> keyword in <code>ask_question</code> is pointing at the DOM element that generated the event, not at a <code>BigComputer</code> object. The DOM element doesn’t have a <code>the_answer</code> property, so we’re getting back <code>undefined</code> instead of “42.” <code>setTimeout</code> exhibits similar behavior, delaying the execution of a function while at the same time moving it out into a global context.<p>This issue crops up all over the place in our programs, and it’s a terribly difficult problem to debug without keeping careful track of what’s going on in all the corners of your program, especially if your object has properties that <em>do</em> exist on DOM elements or the <code>window</code> object.<h3 id="Manipulating-Context-With-apply-and-call">Manipulating Context With <code>.apply()</code> and <code>.call()</code></h3><p>We really <em>do</em> want to be able to ask <code>deep_thought</code> a question when we click the button, and more generally, we <em>do</em> want to be able to call object methods in their native context when responding to things like events and <code>setTimeout</code> calls. Two little-known JavaScript methods, <code>apply</code> and <code>call</code>, indirectly enable this functionality by allowing us to manually override the /files/includes/default.css value of <code>this</code> when we execute a function call. Let’s look at <code>call</code>first:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> first_object = &#123;</span></span><br><span class="line">	num: 42</span><br><span class="line">&#125;;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> second_object = &#123;</span></span><br><span class="line">	num: 24</span><br><span class="line">&#125;;</span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">multiply</span>(<span class="params">mult</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">return</span> <span class="keyword">this</span>.num * mult;</span></span><br><span class="line">&#125;</span><br><br><span class="line"><span class="javascript">multiply.call(first_object, <span class="number">5</span>); <span class="comment">// returns 42 * 5</span></span></span><br><span class="line"><span class="javascript">multiply.call(second_object, <span class="number">5</span>); <span class="comment">// returns 24 * 5</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>In this example, we first define two objects, <code>first_object</code> and <code>second_object</code>, each with a <code>num</code> property. Then we define a <code>multiply</code> function that accepts a single argument, and returns the product of that argument, and the <code>num</code> property of its <code>this</code> object. If we called that function by itself, the answer returned would almost certainly be <code>undefined</code>, since the global <code>window</code>object doesn’t have a <code>num</code> property unless we explicitly set one. We need some way of telling <code>multiply</code> what its <code>this</code> keyword ought refer to; the <code>call</code> method of the <code>multiply</code> function is exactly what we’re looking for.<p>The first argument to <code>call</code> defines what <code>this</code> means inside the executed function. The remaining arguments to <code>call</code> are passed into the executed function, just as if you’d called it yourself. So, when <code>multiply.call(first_object, 5)</code> is executed, the <code>multiply</code> function is called, <code>5</code> is passed in as the first argument, and the <code>this</code> keyword is set to refer to object <code>first_object</code>. Likewise, when <code>multiply.call(second_object, 5)</code> is executed, the <code>multiply</code> function is called, <code>5</code> is passed in as the first argument, and the <code>this</code> keyword is set to refer to object <code>second_object</code>.<p><code>apply</code> works in exactly the same way as <code>call</code>, but allows you to wrap up the arguments to the called function in an array, which can be quite useful when programatically generating function calls. Replicating the functionality we just talked about using <code>apply</code> is trivial:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="javascript">multiply.apply(first_object, [<span class="number">5</span>]); <span class="comment">// returns 42 * 5</span></span></span><br><span class="line"><span class="javascript">multiply.apply(second_object, [<span class="number">5</span>]); <span class="comment">// returns 24 * 5</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p><code>apply</code> and <code>call</code> are very useful on their own, and well worth keeping around in your toolkit, but they only get us halfway to solving the problem of context shifts for event handlers. It’s easy to think that we could solve the problem by simply using <code>call</code> to shift the meaning of <code>this</code> when we set up the handler:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addhandler</span>() </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> deep_thought = <span class="keyword">new</span> BigComputer(<span class="number">42</span>),</span><br><span class="line">	the_button = <span class="built_in">document</span>.getElementById(<span class="string">'thebutton'</span>);</span><br><span class="line">	the_button.onclick = deep_thought.ask_question.call(deep_thought);</span><br><span class="line">&#125;</span><br></pre></table></figure><p>The problem with this line of reasoning is simple: <code>call</code> executes the function <em>immediately</em>. Instead of providing a function reference to the <code>onclick</code> handler, we’re giving it <em>the result</em> of an executed function. We need to exploit another feature of JavaScript to really solve this problem.<h3 id="The-Beauty-of-bind">The Beauty of <code>.bind()</code></h3><p>I’m not a <em>huge</em> fan of the <a href="http://prototype.conio.net/" target="_blank" rel="noopener">Prototype JavaScript framework</a>, but I am very much impressed with the quality of its code as a whole. In particular, one simple addition it makes to the <code>Function</code> object has had a hugely positive impact on my ability to manage the context in which function calls execute: <code>bind</code> performs the same general task as <code>call</code>, altering the context in which a function executes. The difference is that <code>bind</code> returns a function reference that can be used later, rather than the result of an immediate execution that we get with <code>call</code>.<p>If we simplify the <code>bind</code> function a bit to get at the key concepts, we can insert it into the multiplication example we discussed earlier to really dig into how it works; it’s quite an elegant solution:<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> first_object = &#123;</span></span><br><span class="line">	num: 42</span><br><span class="line">&#125;;</span><br><span class="line"><span class="javascript"><span class="keyword">var</span> second_object = &#123;</span></span><br><span class="line">	num: 24</span><br><span class="line">&#125;;</span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">multiply</span>(<span class="params">mult</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">return</span> <span class="keyword">this</span>.num * mult;</span></span><br><span class="line">&#125;</span><br><br><span class="line"><span class="javascript"><span class="built_in">Function</span>.prototype.bind = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">var</span> method = <span class="keyword">this</span>,</span></span><br><span class="line"><span class="javascript">	temp = <span class="function"><span class="keyword">function</span>() </span>&#123;</span></span><br><span class="line"><span class="javascript">		<span class="keyword">return</span> method.apply(obj, <span class="built_in">arguments</span>);</span></span><br><span class="line">	&#125;;</span><br><br><span class="line"><span class="javascript"><span class="keyword">return</span> temp;</span></span><br><span class="line">&#125;</span><br><br><span class="line"><span class="javascript"><span class="keyword">var</span> first_multiply = multiply.bind(first_object);</span></span><br><span class="line"><span class="javascript">first_multiply(<span class="number">5</span>); <span class="comment">// returns 42 * 5</span></span></span><br><br><span class="line"><span class="javascript"><span class="keyword">var</span> second_multiply = multiply.bind(second_object);</span></span><br><span class="line"><span class="javascript">second_multiply(<span class="number">5</span>); <span class="comment">// returns 24 * 5</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></table></figure><p>First, we define <code>first_object</code>, <code>second_object</code>, and the <code>multiply</code> function, just as before. With those taken care of, we move on to creating a <code>bind</code> method on the <code>Function</code> object’s <a href="http://en.wikipedia.org/wiki/Prototype-based_programming" target="_blank" rel="noopener"><code>prototype</code></a>, which has the effect of making <code>bind</code> available for all functions in our program. When <code>multiply.bind(first_object)</code> is called, JavaScript creates an execution context for the <code>bind</code> method, setting <code>this</code> to the <code>multiply</code> function, and setting the first argument, <code>obj</code>, to reference <code>first_object</code>. So far, so good.<p>The real genius of this solution is the creation of <code>method</code>, set equal to <code>this</code> (the <code>multiply</code>function itself). When the anonymous function is created on the next line, <code>method</code> is accessible via its scope chain, as is <code>obj</code> (<code>this</code> couldn’t be used here, because when the newly created function is executed, <code>this</code> will be overwritten by a new, local context). This alias to <code>this</code> makes it possible to use <code>apply</code> to execute the <code>multiply</code> function, passing in <code>obj</code> to ensure that the context is set correctly. In computer-science-speak, <code>temp</code> is a <a href="http://www.jibbering.com/faq/faq_notes/closures.html" target="_blank" rel="noopener">closure</a> that, when returned at the end of the <code>bind</code> call, can be used in any context whatsoever to execute <code>multiply</code> in the context of <code>first_object</code>.<p>This is exactly what we need for the event handler and <code>setTimeout</code> scenarios discussed above. The following code solves that problem completely, binding the <code>deep_thought.ask_question</code>method to the <code>deep_thought</code> context, so that it executes correctly whenever the event is triggered:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addhandler</span>() </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> deep_thought = <span class="keyword">new</span> BigComputer(<span class="number">42</span>),</span><br><span class="line">	the_button = <span class="built_in">document</span>.getElementById(<span class="string">'thebutton'</span>);</span><br><span class="line">	the_button.onclick = deep_thought.ask_question.bind(deep_thought);</span><br><span class="line">&#125;</span><br></pre></table></figure><p>Beautiful.<h3 id="References">References</h3><ul><li><a href="http://www.jibbering.com/faq/faq_notes/closures.html" target="_blank" rel="noopener">JavaScript Closures</a> is the best resource on the net for a thorough discussion of closures: what they do, how they do it, and how to use them without going insane.<li>The <a href="http://prototype.conio.net/" target="_blank" rel="noopener">Protype JavaScript Framework</a> is full of little nuggets like <code>bind</code>. The version available here not only allows the binding of a particular <code>this</code> value, but also of some or all of a function’s arguments, which comes in handy all too often.<li><a href="http://javascript.crockford.com/" target="_blank" rel="noopener">Douglas Crockford’s JavaScript essays</a> are excellent resources for both basic and advanced JavaScript programmers. The man knows what he’s talking about, and explains difficult concepts in an easy-to-grasp manner.<li><a href="http://www.digital-web.com/articles/variable_scope_for_new_programmers/" target="_blank" rel="noopener">Variable Scope for New Programmers</a> is a good article if you’d like more discussion of scope from a beginner’s perspective. Written by <a href="http://snook.ca/" target="_blank" rel="noopener">Jonathan Snook</a>, and published in this very magazine at the end of last year, it’s still an informative and useful read.</ul></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js" integrity="sha256-iBcUE/x23aI6syuqF7EeT/+JFBxjPs5zeFJEXxumwb0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.min.js" integrity="sha256-JirYRqbf+qzfqVtEE4GETyHlAbiCpC005yBTa4rj6xg=" crossorigin="anonymous"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-sweetalert/1.0.1/sweetalert.min.css" integrity="sha256-zuyRv+YsWwh1XR5tsrZ7VCfGqUmmPmqBjIvJgQWoSDo=" crossorigin="anonymous"><p><span>本文标题:</span>JavaScript作用域<p><span>文章作者:</span>kinboy<p><span>发布时间:</span>2019年02月13日 - 16:43:28<p><span>最后更新:</span>2019年07月15日 - 18:05:10<p><span>原始链接:</span><a href="/2019/02/13/JavaScript作用域/" title="JavaScript作用域">http://kinboyw.github.io/2019/02/13/JavaScript作用域/</a><span class="copy-path" title="点击复制文章链接"></span><p><span>许可协议:</span> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</div><script>var clipboard=new Clipboard(".fa-clipboard");clipboard.on("success",$(function(){$(".fa-clipboard").click(function(){swal({title:"",text:"复制成功",html:!1,timer:500,showConfirmButton:!1})})}))</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------ Passage Ending ------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> kinboy<li class="post-copyright-link"><strong>Post link:</strong> <a href="http://kinboyw.github.io/2019/02/13/JavaScript作用域/" title="JavaScript作用域">http://kinboyw.github.io/2019/02/13/JavaScript作用域/</a><li class="post-copyright-license"><strong>Copyright Notice:</strong> All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/FE/" rel="tag"># FE</a> <a href="/tags/JavaScript/" rel="tag"># JavaScript</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/17/配置-Nginx-HTTPS-服务器/" rel="next" title="配置 Nginx HTTPS 服务器">配置 Nginx HTTPS 服务器</a></div><div class="post-nav-prev post-nav-item"><a href="/2019/02/15/JavaScript中的New关键字/" rel="prev" title="JavaScript中的New关键字">JavaScript中的New关键字</a></div></div></footer></div></article></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents<li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="kinboy"><p class="site-author-name" itemprop="name">kinboy</div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">31</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">52</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate">RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/kinboyw" target="_blank" title="GitHub">GitHub</a></span><span class="links-of-author-item"><a href="mailto:kinboy9275@gmail.com" target="_blank" title="E-Mail"> E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#this？是什么？"><span class="nav-number">1.</span> <span class="nav-text">this？是什么？</span></a><li class="nav-item nav-level-3"><a class="nav-link" href="#Complications"><span class="nav-number">2.</span> <span class="nav-text">Complications</span></a><li class="nav-item nav-level-3"><a class="nav-link" href="#Manipulating-Context-With-apply-and-call"><span class="nav-number">3.</span> <span class="nav-text">Manipulating Context With .apply() and .call()</span></a><li class="nav-item nav-level-3"><a class="nav-link" href="#The-Beauty-of-bind"><span class="nav-number">4.</span> <span class="nav-text">The Beauty of .bind()</span></a><li class="nav-item nav-level-3"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></ol></div></div></section><div class="back-to-top"><span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"></span> <span class="author" itemprop="copyrightHolder">kinboy</span><br><img src="/images/beian.png"> <span style="width:300px;margin:0 auto;padding:20px 0"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=42011102002861" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src style="float:left"><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">鄂公网安备 42011102002861号</p></a></span></div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script id="dsq-count-scr" src="https://kinboy-wang.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="http://kinboyw.github.io/2019/02/13/JavaScript作用域/",this.page.identifier="2019/02/13/JavaScript作用域/",this.page.title="JavaScript作用域"},d=document,s=d.createElement("script");s.src="https://kinboy-wang.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>